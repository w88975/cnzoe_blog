import{r as c,c as B,o as D,h as U,u as z,j as P,k as d,C as O,D as j,a as A,m as f,n as E,y as b,t as m,e as n,d as y,E as x,B as F,i as _}from"./index-5aWETVbQ.js";import{b as M,c as V,d as q}from"./91porn-sS56_kcf.js";import{s as H,O as G}from"./config-C03strlz.js";const J={class:"mb-4 text-sm text-gray-600"},K={class:"mb-1"},Q={class:"mb-1"},W={class:"text-green-600"},X={class:"text-red-600"},Y=["innerHTML"],se={__name:"91PornDetail",setup(Z){const k=j(),I=F(),u=c(null),e=c({authorName:"",authorUID:"",title:"",postTime:"",content:"",images:[],saved_imgs:"",is_like:!1}),r=c("initial"),p=c(!1),g=c(0),T=B(()=>{var t;return((t=e.value.images)==null?void 0:t.length)||0}),$=c(null),N=t=>{I.push({name:"favorite",query:{author:t}})},L=async()=>{const t=await q(u.value);p.value=t.data.data.isLiked};D(async()=>{u.value=k.query.tid;const t=await M(u.value);if(e.value=t.data,p.value=e.value.is_like===1,e.value.images&&e.value.images.length>0&&e.value.saved_imgs){const a=e.value.images,l=e.value.saved_imgs.split(",");if(a.length===l.length)for(let s=0;s<a.length;s++){const i=a[s],o=l[s];e.value.content&&(e.value.content=e.value.content.replace(new RegExp(i,"g"),o))}else console.warn("The number of old images does not match the number of saved images.")}e.value.content&&(e.value.content=e.value.content.replace(/<img\s+src="([^"]+)"/gi,'<img class="lazy-img" data-src="$1" loading="lazy"')),U(()=>{R()}),e.value.full_save?r.value="saved":(console.log("自动缓存"),w())});const C=()=>{switch(r.value){case"saving":return`保存中 (${g.value}/${T.value})`;case"saved":return"已保存";default:return"保存文档"}},w=async()=>{if(!(r.value==="saving"||r.value==="saved"))if(e.value.images&&e.value.images.length>0){const t="/porn91";try{r.value="saving",g.value=0;const a=[],l=e.value.images.map(async(s,i)=>{const o=`https://91porn.lwhzak.workers.dev/${s}`,h=`${e.value.authorName}_${u.value}_`,v=await S(o,t,h);await H({url:v.url,fileSize:v.fileSize,dir:t,originalUrl:o,title:e.value.title,authorName:e.value.authorName,postTime:e.value.postTime,tid:u.value}),a.push(G+v.url),g.value+=1});await Promise.all(l),await V(u.value,a.join(",")),console.log("文档保存成功！"),r.value="saved"}catch(a){console.error("保存文档时出错：",a),alert("保存文档失败，请稍后重试。"),r.value="initial"}finally{g.value=0}}else alert("没有图片需要保存")};async function S(t,a,l){try{const i=await(await fetch(t)).blob(),o=l+(t.split("/").pop()||`image_${Date.now()}.jpg`),h=new File([i],o,{type:i.type}),v=await z(h,()=>{},a);return URL.revokeObjectURL(t),v}catch(s){throw console.error("下载或上传图片时出错：",s),s}}const R=()=>{console.log("handleImageLoad");const t=document.querySelectorAll(".article-content img[data-src]"),a={root:null,rootMargin:"0px",threshold:.1},l=new IntersectionObserver(s=>{s.forEach(i=>{if(i.isIntersecting){const o=i.target;o.src=o.dataset.src,o.onload=()=>o.removeAttribute("data-src"),l.unobserve(o)}})},a);t.forEach(s=>{l.observe(s)})};return(t,a)=>{const l=_("NvaButton"),s=_("a-space"),i=_("TitleLine");return A(),P(O,null,{default:d(()=>[f(i,{title:e.value.title||"加载中..."},{right:d(()=>[f(s,null,{default:d(()=>[f(l,{type:"primary",onClick:L,class:E({"bg-red-500":p.value})},{default:d(()=>[b(m(p.value?"已收藏":"收藏"),1)]),_:1},8,["class"]),f(l,{type:"primary",onClick:w,disabled:r.value==="saving"||r.value==="saved"},{default:d(()=>[b(m(C()),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["title"]),n("div",J,[n("p",K,[a[1]||(a[1]=n("span",{class:"font-semibold"},"作者：",-1)),n("span",{onClick:a[0]||(a[0]=o=>N(e.value.authorName)),class:"text-blue-600 cursor-pointer hover:underline"},m(e.value.authorName),1)]),n("p",Q,[a[2]||(a[2]=n("span",{class:"font-semibold"},"发帖时间：",-1)),n("span",W,m(e.value.postTime),1)]),n("p",null,[a[3]||(a[3]=n("span",{class:"font-semibold"},"图片数量：",-1)),n("span",X,m(e.value.images.length),1)])]),n("div",{class:"article-content",ref_key:"articleContent",ref:$},[y(n("div",{innerHTML:e.value.content},null,8,Y),[[x,e.value.content]]),y(n("p",null,"加载中...",512),[[x,!e.value.content]])],512)]),_:1})}}};export{se as default};
