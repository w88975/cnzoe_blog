import{h as u,j as V,b as M,k as O,l as A,d as E,w as v,B as q,m as H,o as f,e as g,n as x,f as b,t as d,c as k,F as J,i as G,a as n,p as I,v as L,u as K,g as $}from"./index-BTHmfypp.js";import{b as Q,c as W,d as X,e as Y}from"./91porn-DtS3ACCT.js";import{s as Z,O as ee}from"./config-Ckr-ZDdX.js";const ae={key:0,class:"grid grid-cols-2 gap-4"},te=["src"],se={key:1},oe={class:"mb-4 text-sm text-gray-600"},le={class:"mb-1"},ne={class:"mb-1"},ie={class:"text-green-600"},re={class:"text-red-600"},ue=["innerHTML"],me={__name:"91PornDetail",setup(ce){const N=H(),C=K(),c=u(null),e=u({authorName:"",authorUID:"",title:"",postTime:"",content:"",images:[],saved_imgs:"",is_like:!1,is_jiping:!1}),r=u("initial"),h=u(!1),w=u(!1),y=u(0),S=V(()=>{var t;return((t=e.value.images)==null?void 0:t.length)||0}),B=u(null),R=t=>{C.push({name:"favorite",query:{author:t}})},U=async()=>{const t=await X(c.value);h.value=t.data.data.isLiked},j=async()=>{const t=await Y(c.value);w.value=t.data.data.is_jiping},m=u(!0),D=()=>{m.value=!m.value};M(async()=>{c.value=N.query.tid;const t=await Q(c.value);if(e.value=t.data,h.value=e.value.is_like===1,w.value=e.value.is_jiping===1,e.value.images&&e.value.images.length>0&&e.value.saved_imgs){const a=e.value.images,o=e.value.saved_imgs.split(",");if(a.length===o.length){e.value.images=o;for(let s=0;s<a.length;s++){const i=a[s],l=o[s];e.value.content&&(e.value.content=e.value.content.replace(new RegExp(i,"g"),l))}}else console.warn("The number of old images does not match the number of saved images.")}e.value.content&&(e.value.content=e.value.content.replace(/<img\s+src="([^"]+)"/gi,'<img class="lazy-img" data-src="$1" loading="lazy"')),O(()=>{P()}),e.value.full_save?r.value="saved":(console.log("自动缓存"),T())});const z=()=>{switch(r.value){case"saving":return`保存中 (${y.value}/${S.value})`;case"saved":return"已保存";default:return"保存文档"}},T=async()=>{if(!(r.value==="saving"||r.value==="saved"))if(e.value.images&&e.value.images.length>0){const t="/porn91";try{r.value="saving",y.value=0;const a=[],o=e.value.images.map(async(s,i)=>{const l=`https://91porn.lwhzak.workers.dev/${s}`,p=`${e.value.authorName}_${c.value}_`,_=await F(l,t,p);await Z({url:_.url,fileSize:_.fileSize,dir:t,originalUrl:l,title:e.value.title,authorName:e.value.authorName,postTime:e.value.postTime,tid:c.value}),a.push(ee+_.url),y.value+=1});await Promise.all(o),await W(c.value,a.join(",")),console.log("文档保存成功！"),r.value="saved"}catch(a){console.error("保存文档时出错：",a),alert("保存文档失败，请稍后重试。"),r.value="initial"}finally{y.value=0}}else alert("没有片需要保存")};async function F(t,a,o){try{const i=await(await fetch(t)).blob(),l=o+(t.split("/").pop()||`image_${Date.now()}.jpg`),p=new File([i],l,{type:i.type}),_=await A(p,()=>{},a);return URL.revokeObjectURL(t),_}catch(s){throw console.error("下载或上传图片时出错：",s),s}}const P=()=>{console.log("handleImageLoad");const t=document.querySelectorAll(".article-content img[data-src]"),a={root:null,rootMargin:"0px",threshold:.1},o=new IntersectionObserver(s=>{s.forEach(i=>{if(i.isIntersecting){const l=i.target;l.src=l.dataset.src,l.onload=()=>l.removeAttribute("data-src"),o.unobserve(l)}})},a);t.forEach(s=>{o.observe(s)})};return(t,a)=>{const o=$("NvaButton"),s=$("a-space"),i=$("TitleLine");return f(),E(q,null,{default:v(()=>[g(i,{title:e.value.title||"加载中..."},{right:v(()=>[g(s,null,{default:v(()=>[g(o,{type:"primary",onClick:D,class:x({"bg-red-500":m.value})},{default:v(()=>[b(d(m.value?"切换到列表模式":"切换到看图模式"),1)]),_:1},8,["class"]),g(o,{type:"primary",onClick:U,class:x({"bg-red-500":h.value})},{default:v(()=>[b(d(h.value?"已收藏":"收藏"),1)]),_:1},8,["class"]),g(o,{type:"primary",onClick:j,class:x({"bg-red-500":w.value})},{default:v(()=>[b(d(w.value?"已喜欢":"喜欢"),1)]),_:1},8,["class"]),g(o,{type:"primary",onClick:T,disabled:r.value==="saving"||r.value==="saved"},{default:v(()=>[b(d(z()),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["title"]),m.value?(f(),k("div",ae,[(f(!0),k(J,null,G(e.value.images,(l,p)=>(f(),k("img",{key:p,src:l,class:"w-full h-auto"},null,8,te))),128))])):(f(),k("div",se,[n("div",oe,[n("p",le,[a[1]||(a[1]=n("span",{class:"font-semibold"},"作者：",-1)),n("span",{onClick:a[0]||(a[0]=l=>R(e.value.authorName)),class:"text-blue-600 cursor-pointer hover:underline"},d(e.value.authorName),1)]),n("p",ne,[a[2]||(a[2]=n("span",{class:"font-semibold"},"发帖时间：",-1)),n("span",ie,d(e.value.postTime),1)]),n("p",null,[a[3]||(a[3]=n("span",{class:"font-semibold"},"图片数量：",-1)),n("span",re,d(e.value.images.length),1)])]),n("div",{class:"article-content",ref_key:"articleContent",ref:B},[I(n("div",{innerHTML:e.value.content},null,8,ue),[[L,e.value.content]]),I(n("p",null,"加载中...",512),[[L,!e.value.content]])],512)]))]),_:1})}}};export{me as default};
