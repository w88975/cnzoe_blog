import{r as u,c as $,f as L,x as S,q as k,w as v,B as R,y as U,o as B,j as f,v as D,t as p,e as o,z as w,A as b,h as _}from"./index-CIFeV0ri.js";import{b as z,c as C}from"./91porn-BCzxpmYU.js";import{s as P,O,u as j}from"./config-CXPb3WQJ.js";import"./index-B_qLKurY.js";const A={class:"mb-4 text-sm text-gray-600"},M={class:"mb-1"},V={class:"text-blue-600"},q={class:"mb-1"},E={class:"text-green-600"},F={class:"text-red-600"},H=["innerHTML"],X={__name:"91PornDetail",setup(G){const y=U(),r=u(null),e=u({authorName:"",authorUID:"",title:"",postTime:"",content:"",images:[],saved_imgs:""}),d=u(!1),m=u(0),x=$(()=>{var s;return((s=e.value.images)==null?void 0:s.length)||0}),I=u(null);L(async()=>{r.value=y.query.tid;const s=await z(r.value);if(e.value=s.data,e.value.images&&e.value.images.length>0&&e.value.saved_imgs){const t=e.value.images,l=e.value.saved_imgs.split(",");if(t.length===l.length)for(let a=0;a<t.length;a++){const i=t[a],n=l[a];e.value.content&&(e.value.content=e.value.content.replace(new RegExp(i,"g"),n))}else console.warn("The number of old images does not match the number of saved images.")}e.value.content&&(e.value.content=e.value.content.replace(/<img\s+src="([^"]+)"/gi,'<img class="lazy-img" data-src="$1" loading="lazy"')),S(()=>{N()}),e.value.full_save||(console.log("自动缓存"),h())});const h=async()=>{if(e.value.images&&e.value.images.length>0){const s="/porn91";try{d.value=!0,m.value=0;const t=[],l=e.value.images.map(async(a,i)=>{const n=`https://91porn.lwhzak.workers.dev/${a}`,g=`${e.value.authorName}_${r.value}_`,c=await T(n,s,g);await P({url:c.url,fileSize:c.fileSize,dir:s,originalUrl:n,title:e.value.title,authorName:e.value.authorName,postTime:e.value.postTime,tid:r.value}),t.push(O+c.url),m.value+=1});await Promise.all(l),await C(r.value,t.join(",")),console.log("文档保存成功！")}catch(t){console.error("保存文档时出错：",t),alert("保存文档失败，请稍重试。")}finally{d.value=!1,m.value=0}}else alert("没有图片需要保存���")};async function T(s,t,l){try{const i=await(await fetch(s)).blob(),n=l+(s.split("/").pop()||`image_${Date.now()}.jpg`),g=new File([i],n,{type:i.type}),c=await j(g,()=>{},t);return URL.revokeObjectURL(s),c}catch(a){throw console.error("下载或上传图片时出错：",a),a}}const N=()=>{console.log("handleImageLoad");const s=document.querySelectorAll(".article-content img[data-src]"),t={root:null,rootMargin:"0px",threshold:.1},l=new IntersectionObserver(a=>{a.forEach(i=>{if(i.isIntersecting){const n=i.target;n.src=n.dataset.src,n.onload=()=>n.removeAttribute("data-src"),l.unobserve(n)}})},t);s.forEach(a=>{l.observe(a)})};return(s,t)=>{const l=_("NvaButton"),a=_("a-space"),i=_("TitleLine");return B(),k(R,null,{default:v(()=>[f(i,{title:e.value.title||"加载中..."},{right:v(()=>[f(a,null,{default:v(()=>[f(l,{type:"primary",onClick:h},{default:v(()=>[D(p(d.value?`保存中 (${m.value}/${x.value})`:"保存文档"),1)]),_:1})]),_:1})]),_:1},8,["title"]),o("div",A,[o("p",M,[t[0]||(t[0]=o("span",{class:"font-semibold"},"作者：",-1)),o("span",V,p(e.value.authorName),1)]),o("p",q,[t[1]||(t[1]=o("span",{class:"font-semibold"},"发帖时间：",-1)),o("span",E,p(e.value.postTime),1)]),o("p",null,[t[2]||(t[2]=o("span",{class:"font-semibold"},"图片数量：",-1)),o("span",F,p(e.value.images.length),1)])]),o("div",{class:"article-content",ref_key:"articleContent",ref:I},[w(o("div",{innerHTML:e.value.content},null,8,H),[[b,e.value.content]]),w(o("p",null,"加载中...",512),[[b,!e.value.content]])],512)]),_:1})}}};export{X as default};
