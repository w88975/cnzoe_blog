import{r as u,c as $,f as L,x as S,q as k,w as v,y as R,o as U,j as f,v as B,t as p,e as o,z as _,A as w,h}from"./index-CjaOFfz9.js";import{b as D,c as z}from"./91porn-B6wa7PT5.js";import{s as C,O as P,u as O}from"./config-lMX1jjW9.js";import{B as j}from"./BoxView-Bdj1oUb4.js";import"./index-DSuMsvKw.js";const A={class:"mb-4 text-sm text-gray-600"},M={class:"mb-1"},V={class:"text-blue-600"},q={class:"mb-1"},E={class:"text-green-600"},F={class:"text-red-600"},H=["innerHTML"],Y={__name:"91PornDetail",setup(G){const b=R(),i=u(null),e=u({authorName:"",authorUID:"",title:"",postTime:"",content:"",images:[],saved_imgs:""}),d=u(!1),m=u(0),y=$(()=>{var s;return((s=e.value.images)==null?void 0:s.length)||0}),x=u(null);L(async()=>{i.value=b.query.tid;const s=await D(i.value);if(e.value=s.data,e.value.images&&e.value.images.length>0&&e.value.saved_imgs){const t=e.value.images,l=e.value.saved_imgs.split(",");if(t.length===l.length)for(let a=0;a<t.length;a++){const r=t[a],n=l[a];e.value.content&&(e.value.content=e.value.content.replace(new RegExp(r,"g"),n))}else console.warn("The number of old images does not match the number of saved images.")}e.value.content&&(e.value.content=e.value.content.replace(/<img\s+src="([^"]+)"/gi,'<img class="lazy-img" data-src="$1" loading="lazy"')),S(()=>{N()})});const I=async()=>{if(e.value.images&&e.value.images.length>0){const s="/porn91";try{d.value=!0,m.value=0;const t=[],l=e.value.images.map(async(a,r)=>{const n=`https://91porn.lwhzak.workers.dev/${a}`,g=`${e.value.authorName}_${i.value}_`,c=await T(n,s,g);await C({url:c.url,fileSize:c.fileSize,dir:s,originalUrl:n,title:e.value.title,authorName:e.value.authorName,postTime:e.value.postTime,tid:i.value}),t.push(P+c.url),m.value+=1});await Promise.all(l),await z(i.value,t.join(",")),alert("文档保存成功！")}catch(t){console.error("保存文档时出错：",t),alert("保存文档失败，请稍重试。")}finally{d.value=!1,m.value=0}}else alert("没有图片需要保存���")};async function T(s,t,l){try{const r=await(await fetch(s)).blob(),n=l+(s.split("/").pop()||`image_${Date.now()}.jpg`),g=new File([r],n,{type:r.type}),c=await O(g,()=>{},t);return URL.revokeObjectURL(s),c}catch(a){throw console.error("下载或上传图片时出错：",a),a}}const N=()=>{console.log("handleImageLoad");const s=document.querySelectorAll(".article-content img[data-src]"),t={root:null,rootMargin:"0px",threshold:.1},l=new IntersectionObserver(a=>{a.forEach(r=>{if(r.isIntersecting){const n=r.target;n.src=n.dataset.src,n.onload=()=>n.removeAttribute("data-src"),l.unobserve(n)}})},t);s.forEach(a=>{l.observe(a)})};return(s,t)=>{const l=h("NvaButton"),a=h("a-space"),r=h("TitleLine");return U(),k(j,null,{default:v(()=>[f(r,{title:e.value.title||"加载中..."},{right:v(()=>[f(a,null,{default:v(()=>[f(l,{type:"primary",onClick:I},{default:v(()=>[B(p(d.value?`保存中 (${m.value}/${y.value})`:"保存文档"),1)]),_:1})]),_:1})]),_:1},8,["title"]),o("div",A,[o("p",M,[t[0]||(t[0]=o("span",{class:"font-semibold"},"作者：",-1)),o("span",V,p(e.value.authorName),1)]),o("p",q,[t[1]||(t[1]=o("span",{class:"font-semibold"},"发帖时间：",-1)),o("span",E,p(e.value.postTime),1)]),o("p",null,[t[2]||(t[2]=o("span",{class:"font-semibold"},"图片数量：",-1)),o("span",F,p(e.value.images.length),1)])]),o("div",{class:"article-content",ref_key:"articleContent",ref:x},[_(o("div",{innerHTML:e.value.content},null,8,H),[[w,e.value.content]]),_(o("p",null,"加载中...",512),[[w,!e.value.content]])],512)]),_:1})}}};export{Y as default};
